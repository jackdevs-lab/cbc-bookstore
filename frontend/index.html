<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>CBC Books Kenya | Buy Approved CBC Textbooks Grade 1-8 Online</title>
<meta name="description" content="Buy approved CBC books for Grade 1-8 in Kenya. Mathematics, English, Kiswahili textbooks & revision books at best prices. Fast delivery + M-Pesa payment nationwide.">
<meta name="keywords" content="cbc books kenya, cbc grade 1 books, buy cbc textbooks online, approved cbc books, cbc mathematics grade 2, klb cbc books, cbc revision books">

<link rel="icon" href="https://cdn.jsdelivr.net/gh/jackdevs-lab/cbc-favicon@master/favicon.ico">
<link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/jackdevs-lab/cbc-favicon@master/apple-touch-icon.png">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link rel="canonical" href="https://www.cbcbookstore.co.ke/">

<script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        secondary: { 50: '#f8fafc', 100: '#f1f5f9', 500: '#64748b', 600: '#475569' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="font-sans bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <button id="back-btn" class="p-2 rounded-lg hover:bg-gray-100 hidden">
                            <i class="fas fa-arrow-left text-gray-600"></i>
                        </button>
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book text-white text-sm"></i>
                            </div>
                            <h1 class="text-xl font-bold text-primary-600">CBC Books</h1>
                        </div>
                    </div>
                    <button id="cart-btn" class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-shopping-cart text-gray-700"></i>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pb-20">
            <div id="home-page" class="fade-in">
                <section class="gradient-bg text-white py-12">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                        <h2 class="text-3xl font-bold mb-4">Quality Educational Resources</h2>
                        <p class="text-lg opacity-90 max-w-2xl mx-auto mb-8">Discover the best CBC books, learning materials, and educational supplies for all grades</p>
                        <div class="max-w-2xl mx-auto relative">
                            <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Search books, ISBN, publisher..." class="w-full pl-12 pr-4 py-3 rounded-xl text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500">
                        </div>
                    </div>
                </section>

                <section class="py-8">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Browse by Grade</h2>
                        <div id="grades-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>
                </section>

                <section class="py-8 bg-white">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Top Picks</h2>
                            <button id="view-all-btn" class="text-primary-600 font-medium hover:text-primary-700">View All</button>
                        </div>
                        <div id="top-picks-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                </section>

                <section class="py-8">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Learning Supplies</h2>
                            <button id="view-supplies-btn" class="text-primary-600 font-medium hover:text-primary-700">View All</button>
                        </div>
                        <div id="supplies-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                </section>
            </div>

            <div id="products-page" class="hidden fade-in">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">All Products</h2>
                        <button id="filters-toggle" class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-filter text-gray-600"></i> <span>Filters</span>
                        </button>
                    </div>

                    <div id="filters-panel" class="hidden bg-white rounded-xl shadow-card p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h3 class="font-semibold text-gray-7 00 mb-3">Grade</h3>
                                <div id="grade-filters" class="space-y-2 max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Subject</h3>
                                <div id="subject-filters" class="space-y-2 max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-3">Sort By</h3>
                                <select id="sort-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <option value="recent">Recently Added</option>
                                    <option value="price_low">Price: Low to High</option>
                                    <option value="price_high">Price: High to Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                            <button id="clear-filters" class="text-primary-600 hover:text-primary-700 font-medium">Clear All</button>
                            <button id="apply-filters" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Apply</button>
                        </div>
                    </div>

                    <div id="products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    <div id="no-products" class="hidden text-center py-12">
                        <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No products found</h3>
                        <button id="reset-search" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Reset Filters</button>
                    </div>
                </div>
            </div>

            <div id="details-page" class="hidden fade-in">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div id="product-details-content"></div>
                </div>
            </div>

            <div id="checkout-page" class="hidden fade-in">
                <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Checkout</h2>
                    <div class="bg-white rounded-xl shadow-card p-6 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-4">Order Summary</h3>
                        <div id="checkout-items" class="space-y-4"></div>
                        <div class="border-t border-gray-200 mt-4 pt-4 text-right font-semibold text-xl text-primary-600" id="checkout-total">KSh 0</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-card p-6 mb-6 space-y-4">
                        <input type="text" id="customer-name" placeholder="Full Name *" class="w-full p-3 border border-gray-300 rounded-lg">
                        <input type="tel" id="customer-phone" placeholder="Phone Number (07xx or 2547xx) *" class="w-full p-3 border border-gray-300 rounded-lg">
                        <input type="text" id="customer-location" placeholder="Delivery Location (optional)" class="w-full p-3 border border-gray-300 rounded-lg">
                        <select id="delivery-option" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="pickup">Pickup (Free)</option>
                            <option value="delivery">Home Delivery (+KSh 200)</option>
                        </select>
                    </div>
                    <button id="checkout-btn" class="w-full py-4 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 flex items-center justify-center space-x-2">
                        <i class="fas fa-lock"></i> <span>Complete Payment with M-Pesa</span>
                    </button>
                </div>
            </div>

            <div id="success-page" class="hidden fade-in text-center py-12">
                <div class="max-w-md mx-auto">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-green-600 text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">Order Placed Successfully!</h2>
                    <p class="text-gray-600 mb-8">An M-Pesa STK push has been sent. Complete payment to confirm.</p>
                    <button id="continue-shopping" class="w-full py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700">
                        Continue Shopping
                    </button>
                </div>
            </div>
        </main>

        <!-- Cart Sidebar -->
        <div id="cart-sidebar" class="fixed inset-y-0 right-0 z-50 w-full max-w-md bg-white shadow-xl transform translate-x-full transition-transform">
            <div class="flex flex-col h-full">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold">Your Cart</h2>
                    <button id="close-cart" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                </div>
                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                <div id="cart-empty" class="hidden flex-1 flex flex-col items-center justify-center text-gray-500">
                    <i class="fas fa-shopping-cart text-6xl mb-4"></i>
                    <p>Your cart is empty</p>
                </div>
                <div class="border-t p-4">
                    <div class="flex justify-between mb-4 text-xl font-bold">
                        <span>Total</span>
                        <span id="cart-total" class="text-primary-600">KSh 0</span>
                    </div>
                    <button id="proceed-checkout" class="w-full py-3 bg-primary-600 text-white rounded-xl font-semibold hover:bg-primary-700">
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </div>

        <button id="floating-cart" class="fixed bottom-6 right-6 z-40 w-14 h-14 bg-primary-600 text-white rounded-full shadow-lg hover:bg-primary-700 hidden">
            <i class="fas fa-shopping-cart"></i>
            <span id="floating-cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5">0</span>
        </button>

        <div id="overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 hidden"></div>
    </div>

    <script>
        const API_BASE = 'https://cbc-books-backend.onrender.com/api';
        const state = {
            currentPage: 'home',
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            products: [], filteredProducts: [], grades: [], subjects: [], categories: [],
            filters: { grades: [], subjects: [], sortBy: 'recent', searchQuery: '' },
            selectedProduct: null
        };

        const elements = {
            homePage: document.getElementById('home-page'),
            productsPage: document.getElementById('products-page'),
            detailsPage: document.getElementById('details-page'),
            checkoutPage: document.getElementById('checkout-page'),
            successPage: document.getElementById('success-page'),
            backBtn: document.getElementById('back-btn'),
            cartBtn: document.getElementById('cart-btn'), cartCount: document.getElementById('cart-count'),
            searchInput: document.getElementById('search-input'),
            gradesGrid: document.getElementById('grades-grid'),
            topPicksGrid: document.getElementById('top-picks-grid'),
            suppliesGrid: document.getElementById('supplies-grid'),
            viewAllBtn: document.getElementById('view-all-btn'),
            filtersToggle: document.getElementById('filters-toggle'),
            filtersPanel: document.getElementById('filters-panel'),
            gradeFilters: document.getElementById('grade-filters'),
            subjectFilters: document.getElementById('subject-filters'),
            sortSelect: document.getElementById('sort-select'),
            clearFilters: document.getElementById('clear-filters'),
            applyFilters: document.getElementById('apply-filters'),
            productsGrid: document.getElementById('products-grid'),
            noProducts: document.getElementById('no-products'),
            resetSearch: document.getElementById('reset-search'),
            cartSidebar: document.getElementById('cart-sidebar'),
            closeCart: document.getElementById('close-cart'),
            cartItems: document.getElementById('cart-items'),
            cartEmpty: document.getElementById('cart-empty'),
            cartTotal: document.getElementById('cart-total'),
            floatingCart: document.getElementById('floating-cart'),
            floatingCartCount: document.getElementById('floating-cart-count'),
            overlay: document.getElementById('overlay'),
            proceedCheckout: document.getElementById('proceed-checkout'),
            checkoutItems: document.getElementById('checkout-items'),
            checkoutTotal: document.getElementById('checkout-total'),
            customerName: document.getElementById('customer-name'),
            customerPhone: document.getElementById('customer-phone'),
            customerLocation: document.getElementById('customer-location'),
            deliveryOption: document.getElementById('delivery-option'),
            checkoutBtn: document.getElementById('checkout-btn'),
            continueShopping: document.getElementById('continue-shopping'),
            productDetailsContent: document.getElementById('product-details-content')
        };

        // Load all real data from backend
        async function loadRealData() {
            try {
                const [gradesRes, subjectsRes, productsRes] = await Promise.all([
                    fetch(`${API_BASE}/grades`), fetch(`${API_BASE}/subjects`), fetch(`${API_BASE}/products?limit=200`)
                ]);

                const grades = await gradesRes.json();
                const subjects = await subjectsRes.json();
                const products = await productsRes.json();

                state.grades = grades;
                state.subjects = subjects;
                state.products = products.map(p => ({
                    ...p,
                    image: p.image || `https://picsum.photos/300/400?random=${p.id}`
                }));
                state.filteredProducts = [...state.products];

                renderHomePage();
                renderProductsPage();
            } catch (err) {
                alert('Failed to load data. Check your internet connection.');
                console.error(err);
            }
        }

        function navigateTo(page) {
            document.querySelectorAll('#home-page, #products-page, #details-page, #checkout-page, #success-page').forEach(p => p.classList.add('hidden'));
            elements.backBtn.classList.toggle('hidden', page === 'home');
            document.getElementById(page + '-page')?.classList.remove('hidden');
            state.currentPage = page;
            if (page !== 'checkout' && page !== 'success' && state.cart.length > 0) elements.floatingCart.classList.remove('hidden');
            closeCart();
        }

        function addToCart(product) {
            const existing = state.cart.find(i => i.id === product.id);
            if (existing) existing.quantity += 1;
            else state.cart.push({ ...product, quantity: 1 });
            localStorage.setItem('cart', JSON.stringify(state.cart));
            updateCartUI();
            showToast(`Added "${product.title}" to cart`);
        }

        function updateCartUI() {
            const totalItems = state.cart.reduce((s, i) => s + i.quantity, 0);
            const totalPrice = state.cart.reduce((s, i) => s + i.price * i.quantity, 0);

            elements.cartCount.textContent = totalItems;
            elements.cartCount.classList.toggle('hidden', totalItems === 0);
            elements.floatingCartCount.textContent = totalItems;
            elements.cartTotal.textContent = `KSh ${totalPrice}`;
            elements.cartEmpty.classList.toggle('hidden', state.cart.length > 0);
            elements.cartItems.classList.toggle('hidden', state.cart.length === 0);

            elements.cartItems.innerHTML = '';
            state.cart.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex gap-3 bg-gray-50 rounded-lg p-3';
                el.innerHTML = `
                    <img src="${item.image}" class="w-16 h-20 object-cover rounded">
                    <	div class="flex-1">
                        <h4 class="font-medium text-sm line-clamp-2">${item.title}</h4>
                        <p class="text-primary-600 font-bold">KSh ${item.price}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <button class="w-8 h-8 rounded border qty-btn" data-id="${item.id}" data-change="-1">-</button>
                            <span class="w-10 text-center">${item.quantity}</span>
                            <button class="w-8 h-8 rounded border qty-btn" data-id="${item.id}" data-change="1">+</button>
                        </div>
                    </div>
                    <button class="text-red-500 remove-btn" data-id="${item.id}">Remove</button>
                `;
                elements.cartItems.appendChild(el);
            });

            document.querySelectorAll('.qty-btn').forEach(b => b.onclick = (e) => {
                const id = +e.target.dataset.id;
                const change = +e.target.dataset.change;
                const item = state.cart.find(i => i.id === id);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) state.cart = state.cart.filter(i => i.id !== id);
                    localStorage.setItem('cart', JSON.stringify(state.cart));
                    updateCartUI();
                    if (state.currentPage === 'checkout') renderCheckout();
                }
            });

            document.querySelectorAll('.remove-btn').forEach(b => b.onclick = (e) => {
                state.cart = state.cart.filter(i => i.id !== +e.target.dataset.id);
                localStorage.setItem('cart', JSON.stringify(state.cart));
                updateCartUI();
                if (state.currentPage === 'checkout') renderCheckout();
            });
        }

        function renderHomePage() {
            elements.gradesGrid.innerHTML = state.grades.map(g => `
                <div onclick="goToGrade(${g.id})" class="bg-gradient-to-br from-primary-500 to-primary-600 text-white rounded-xl p-6 text-center cursor-pointer hover:scale-105 transition">
                    <div class="font-bold text-xl">${g.name}</div>
                </div>
            `).join('');

            const topPicks = state.products.slice(0, 10);
            elements.topPicksGrid.innerHTML = topPicks.map(p => createProductCard(p)).join('');
            elements.suppliesGrid.innerHTML = state.products.filter(p => p.category_id === 5).slice(0, 8).map(p => createProductCard(p)).join('');
        }

        function renderProductsPage() {
            elements.gradeFilters.innerHTML = state.grades.map(g => `
                <label class="flex items-center"><input type="checkbox" value="${g.id}" class="mr-2 rounded"> ${g.name}</label>
            `).join('');
            elements.subjectFilters.innerHTML = state.subjects.map(s => `
                <label class="flex items-center"><input type="checkbox" value="${s.id}" class="mr-2 rounded"> ${s.name}</label>
            `).join('');
            applyFilters();
        }

        function applyFilters() {
            let filtered = [...state.products];
            const query = elements.searchInput.value.toLowerCase();
            if (query) filtered = filtered.filter(p => p.title.toLowerCase().includes(query) || (p.isbn && p.isbn.includes(query)));

            const grades = Array.from(document.querySelectorAll('#grade-filters input:checked')).map(c => +c.value);
            const subjects = Array.from(document.querySelectorAll('#subject-filters input:checked')).map(c => +c.value);
            if (grades.length) filtered = filtered.filter(p => grades.includes(p.grade_id));
            if (subjects.length) filtered = filtered.filter(p => subjects.includes(p.subject_id));

            const sort = elements.sortSelect.value;
            if (sort === 'price_low') filtered.sort((a, b) => a.price - b.price);
            if (sort === 'price_high') filtered.sort((a, b) => b.price - a.price);

            state.filteredProducts = filtered;
            elements.productsGrid.innerHTML = filtered.length ? filtered.map(p => createProductCard(p)).join('') : '';
            elements.noProducts.classList.toggle('hidden', filtered.length > 0);
        }

        function createProductCard(p) {
            const grade = state.grades.find(g => g.id === p.grade_id)?.name || '';
            const subject = state.subjects.find(s => s.id === p.subject_id)?.name || '';
            return `
                <div onclick="viewProduct(${p.id})" class="bg-white rounded-xl shadow-card overflow-hidden cursor-pointer hover:shadow-card-hover transition">
                    <img src="${p.image}" class="w-full aspect-[3/4] object-cover">
                    <div class="p-3">
                        <div class="text-xs text-gray-500">${grade}${subject ? ' • ' + subject : ''}</div>
                        <h3 class="font-semibold text-sm line-clamp-2 mt-1">${p.title}</h3>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-lg font-bold text-primary-600">KSh ${p.price}</span>
                            <button onclick="event.stopPropagation(); addToCart(${JSON.stringify(p).split('"').join('&quot;')})" class="p-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function viewProduct(id) {
            const p = state.products.find(x => x.id === id);
            state.selectedProduct = p;
            const grade = state.grades.find(g => g.id === p.grade_id)?.name;
            const subject = state.subjects.find(s => s.id === p.subject_id)?.name;
            elements.productDetailsContent.innerHTML = `
                <div class="bg-white rounded-xl shadow-card overflow-hidden">
                    <img src="${p.image}" class="w-full aspect-square object-cover">
                    <div class="p-6">
                        <p class="text-sm text-gray-500">${grade} • ${subject}</p>
                        <h1 class="text-2xl font-bold mt-2">${p.title}</h1>
                        <p class="text-3xl font-bold text-primary-600 mt-4">KSh ${p.price}</p>
                        <div class="my-6 space-y-3 text-sm">
                            ${p.publisher ? `<div><strong>Publisher:</strong> ${p.publisher}</div>` : ''}
                            ${p.isbn ? `<div><strong>ISBN:</strong> ${p.isbn}</div>` : ''}
                            <div><strong>Stock:</strong> ${p.stock || 'Available'}</div>
                        </div>
                        <button onclick="addToCart(state.selectedProduct); openCart()" class="w-full py-4 bg-primary-600 text-white rounded-xl font-bold hover:bg-primary-700">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `;
            navigateTo('details');
        }

        function renderCheckout() {
            const total = state.cart.reduce((s, i) => s + i.price * i.quantity, 0) + (elements.deliveryOption.value === 'delivery' ? 200 : 0);
            elements.checkoutItems.innerHTML = state.cart.map(i => `
                <div class="flex justify-between items-center py-3 border-b">
                    <div class="flex gap-3">
                        <img src="${i.image}" class="w-12 h-16 object-cover rounded">
                        <div>
                            <p class="font-medium">${i.title}</p>
                            <p class="text-sm text-primary-600">KSh ${i.price} × ${i.quantity}</p>
                        </div>
                    </div>
                    <p class="font-bold">KSh ${i.price * i.quantity}</p>
                </div>
            `).join('');
            elements.checkoutTotal.textContent = `KSh ${total}`;
        }

        async function handleCheckout() {
            const name = elements.customerName.value.trim();
            const phoneRaw = elements.customerPhone.value.replace(/\D/g, '');
            if (!name || !phoneRaw) return alert('Fill name and phone');
            if (!/^(254|0)?[71]\d{8}$/.test(phoneRaw)) return alert('Invalid Kenyan phone number');

            const phone = phoneRaw.startsWith('0') ? '254' + phoneRaw.slice(1) : phoneRaw;
            const amount = state.cart.reduce((s, i) => s + i.price * i.quantity, 0) + (elements.deliveryOption.value === 'delivery' ? 200 : 0);

            elements.checkoutBtn.disabled = true;
            elements.checkoutBtn.innerHTML = '<div class="inline-block animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div> Processing...';

            try {
                const res = await fetch(`${API_BASE}/checkout/mpesa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone, amount,
                        items: state.cart.map(i => ({ product_id: i.id, quantity: i.quantity, price: i.price })),
                        customer_name: name,
                        location: elements.customerLocation.value,
                        delivery_option: elements.deliveryOption.value
                    })
                });
                const data = await res.json();
                if (data.success) {
                    state.cart = [];
                    localStorage.removeItem('cart');
                    updateCartUI();
                    navigateTo('success');
                } else {
                    alert(data.error || 'Payment failed');
                }
            } catch (e) {
                alert('Network error. Try again.');
            } finally {
                elements.checkoutBtn.disabled = false;
                elements.checkoutBtn.innerHTML = '<i class="fas fa-lock"></i> Complete Payment with M-Pesa';
            }
        }

        function openCart() { elements.cartSidebar.classList.remove('translate-x-full'); elements.overlay.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
        function closeCart() { elements.cartSidebar.classList.add('translate-x-full'); elements.overlay.classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Event Listeners
        elements.backBtn.onclick = () => navigateTo(state.currentPage === 'checkout' ? 'home' : 'home');
        elements.cartBtn.onclick = elements.floatingCart.onclick = openCart;
        elements.closeCart.onclick = elements.overlay.onclick = closeCart;
        elements.viewAllBtn.onclick = () => { navigateTo('products'); applyFilters(); }
        elements.filtersToggle.onclick = () => elements.filtersPanel.classList.toggle('hidden');
        elements.clearFilters.onclick = () => { document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false); elements.sortSelect.value = 'recent'; applyFilters(); }
        elements.applyFilters.onclick = applyFilters;
        elements.sortSelect.onchange = applyFilters;
        elements.searchInput.oninput = () => { if (state.currentPage !== 'products') navigateTo('products'); setTimeout(applyFilters, 300); };
        elements.proceedCheckout.onclick = () => { renderCheckout(); navigateTo('checkout'); };
        elements.checkoutBtn.onclick = handleCheckout;
        elements.continueShopping.onclick = () => navigateTo('home');
        elements.resetSearch.onclick = () => { elements.searchInput.value = ''; applyFilters(); navigateTo('home'); };

        function goToGrade(id) {
            navigateTo('products');
            document.querySelectorAll('#grade-filters input').forEach(c => c.checked = c.value == id);
            applyFilters();
        }

        // Start the app
        loadRealData();
        updateCartUI();
    </script>
</body>
</html>